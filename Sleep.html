<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Sleep</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
    }
    .container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #wheel-section {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    #wheel {
      width: 400px;
      height: 400px;
      border-radius: 50%;
      border: 10px solid #333;
      overflow: hidden;
      transform: rotate(0deg);
      transition: transform 5s ease-out;
    }
    #arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -200px); /* -200pxì€ ë£°ë › ë°˜ì§€ë¦„ê³¼ í™”ì‚´í‘œ ë†’ì´ë¥¼ ê³ ë ¤í•œ ê°’ */
      width: 0;
      height: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-top: 30px solid red; /* ë°©í–¥ì„ ì•„ë˜ë¡œ í–¥í•˜ë„ë¡ ìˆ˜ì • */
      z-index: 10;
    }

    #wheelCanvas {
      width: 100%;
      height: 100%;
    }
    #control-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    #spinButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    .option-setting {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      align-items: center;
    }
    .option-setting input {
      padding: 5px;
      font-size: 14px;
    }
    .option-setting button {
      padding: 5px 10px;
    }
    #control-panel button {
      margin: 5px 5px 5px 0;
    }
    
    #slots div {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    
    #slotControls h3 {
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    
    #slotControls button {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .option-setting input[type="text"] {
      flex: 1;
    }
    .option-setting input[type="number"] {
      width: 60px;
    }
    .option-setting input[type="color"] {
      width: 40px;
      padding: 0;
      border: none;
      background: none;
    }
    .option-setting button {
      width: 50px;
    }
    #globalControls {
      margin-top: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container">
  <div id="wheel-section">
    <div id="arrow"></div>
    <div id="wheel">
      <canvas id="wheelCanvas" width="400" height="400"></canvas>
    </div>
  </div>
  <div id="control-panel">
    <button id="spinButton">ëŒë¦¬ê¸°</button>
    <div id="result"></div>
    <div id="settings"></div>
    <div id="globalControls">
      <button id="addOption">í•­ëª© ì¶”ê°€</button>
      <button id="saveSettings">ì „ì²´ ì €ì¥</button>
      <button id="loadSettings">ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="resetToDefault">ë£°ë › ì´ˆê¸°í™”</button>
    </div>

      <div id="slotControls">
        <h3>ìŠ¬ë¡¯ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <div id="slots"></div>
      </div>
    
  </div>
</div>

<script>
  const wheelCanvas = document.getElementById('wheelCanvas');
  const ctx = wheelCanvas.getContext('2d');
  const spinButton = document.getElementById('spinButton');
  const resultDiv = document.getElementById('result');
  const settingsDiv = document.getElementById('settings');
  const addOptionBtn = document.getElementById('addOption');

  let options = Array.from({ length: 30 }, (_, i) => ({
    name: `${i + 1}`,
    probability: 999,
    color: `hsl(${(i * 12) % 360}, 80%, 60%)`
  }));

  const savedOptions = localStorage.getItem('rouletteOptions');
  if (savedOptions) {
    try {
      options = JSON.parse(savedOptions);
    } catch {
      options = Array.from({ length: 30 }, (_, i) => ({
        name: `${i + 1}`,
        probability: 999,
        color: `hsl(${(i * 12) % 360}, 80%, 60%)`
      }));
    }
  } else {
    options = Array.from({ length: 30 }, (_, i) => ({
      name: `${i + 1}`,
      probability: 999,
      color: `hsl(${(i * 12) % 360}, 80%, 60%)`
    }));
  }


  let rotation = 0;
  let spinning = false;

  // ë£°ë ›ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
  function drawWheel(highlightIndex = -1, blink = false) {
  ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

  const total = options.reduce((sum, o) => sum + o.probability, 0);
  let startAngle = -Math.PI / 2;

  options.forEach((option, index) => {
    const sliceAngle = (option.probability / total) * 2 * Math.PI;

    ctx.beginPath();
    ctx.moveTo(200, 200);
    ctx.arc(200, 200, 200, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = option.color || '#888'; // fallback color
    ctx.fill();

    if (index === highlightIndex && blink) {
      ctx.lineWidth = 5;
      ctx.strokeStyle = '#FFD700';
      ctx.stroke();
    }

    ctx.save();
    ctx.translate(200, 200);
    ctx.rotate(startAngle + sliceAngle / 2);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.font = '14px Arial';
    ctx.fillText(option.name, 180, 10);
    ctx.restore();

    startAngle += sliceAngle;
  });
}


  // í™•ë¥ ì— ë”°ë¥¸ í•­ëª©ì„ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ëŠ” í•¨ìˆ˜
  function pickByProbability() {
    const total = options.reduce((sum, opt) => sum + opt.probability, 0);
    const r = Math.random() * total;
    let acc = 0;
    for (const option of options) {
      acc += option.probability;
      if (r <= acc) return option;
    }
    return options[options.length - 1];
  }

  // ë£°ë ›ì„ ëŒë¦¬ëŠ” í•¨ìˆ˜
  function spinWheel() {
  if (spinning) return;
  spinning = true;

  const total = options.reduce((sum, o) => sum + o.probability, 0);
  const target = pickByProbability();

  // ê·¸ë ¤ì§„ ë£°ë ›ì—ì„œ ê° í•­ëª©ì˜ ì‹œì‘, ë ê°ë„ë¥¼ ê³„ì‚°
  let startAngle = -90; // ê¸°ì¤€ì ì„ 12ì‹œ ë°©í–¥ìœ¼ë¡œ (-90ë„)
  let targetIndex = 0;
  for (let i = 0; i < options.length; i++) {
    const angle = (options[i].probability / total) * 360;
    if (options[i] === target) {
      break;
    }
    startAngle += angle;
    targetIndex++;
  }

  const sliceAngle = (target.probability / total) * 360;
  // slice ì¤‘ì•™ì—ì„œ ì•½ê°„ ë¬´ì‘ìœ„ í¸ì°¨ ì£¼ê¸° (-sliceAngle/4 ~ +sliceAngle/4)
  const offset = (Math.random() - 0.5) * sliceAngle * 0.5;
  const targetAngle = startAngle + sliceAngle / 2 + offset;


  // í˜„ì¬ rotationì—ì„œ ëª‡ ë°”í€´ ëŒê³  targetAngleì— ë©ˆì¶”ë„ë¡ ê³„ì‚°
  const fullSpins = 5 * 360;
  const newRotation = fullSpins + (360 - targetAngle);
  rotation += newRotation;

  document.getElementById('wheel').style.transform = `rotate(${rotation}deg)`;

  setTimeout(() => {
  const finalRotation = rotation % 360;
  const finalAngle = (360 - (finalRotation % 360)) % 360;

  const total = options.reduce((sum, o) => sum + o.probability, 0);
  let angleAccumulator = 0;
  let resultIndex = -1;
  let result = null;
  for (let i = 0; i < options.length; i++) {
    const angleSize = (options[i].probability / total) * 360;
    const start = angleAccumulator;
    const end = angleAccumulator + angleSize;
    if (finalAngle >= start && finalAngle < end) {
      result = options[i];
      resultIndex = i;
      break;
    }
    angleAccumulator += angleSize;
  }

  resultDiv.innerText = `ê²°ê³¼: ${result?.name ?? 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
  spinning = false;

  // ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜
  let blink = false;
  let blinkCount = 0;
  const blinkInterval = setInterval(() => {
    blink = !blink;
    drawWheel(resultIndex, blink);
    blinkCount++;
    if (blinkCount >= 6) {
      clearInterval(blinkInterval);
      drawWheel(); // ë‹¤ì‹œ ì›ìƒë³µêµ¬
    }
  }, 500);
}, 5000);
  }

  function createSettingsForm() {
    settingsDiv.innerHTML = '';
    options.forEach((option, index) => {
      const row = document.createElement('div');
      row.className = 'option-setting';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = option.name;
      nameInput.oninput = e => {
        option.name = e.target.value;
        drawWheel();
      };

      const probInput = document.createElement('input');
      probInput.type = 'number';
      probInput.value = option.probability;
      probInput.min = 0;
      probInput.max = 999;
      probInput.oninput = e => {
        option.probability = parseInt(e.target.value) || 0;
        drawWheel();
      };

      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = option.color;
      colorInput.oninput = e => {
        option.color = e.target.value;
        drawWheel();
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'ì‚­ì œ';
      delBtn.onclick = () => {
        options.splice(index, 1);
        createSettingsForm();
        drawWheel();
      };

      row.append(nameInput, probInput, colorInput, delBtn);
      settingsDiv.appendChild(row);
    });
  }

  addOptionBtn.onclick = () => {
    options.push({ name: `${options.length + 1}`, probability: 999, color: '#cccccc' });
    createSettingsForm();
    drawWheel();
  };

  // ì´ˆê¸°í™” ì‹œ íšŒì „ê°ì„ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì²« ì‹œì‘ì—ì„œ í™”ì‚´í‘œê°€ 12ì‹œ ë°©í–¥ì„ ê°€ë¦¬í‚¤ê²Œ í•¨
  rotation = 0; // ì´ˆê¸° ìƒíƒœì—ì„œ íšŒì „ ê°ë„ë¥¼ 0ìœ¼ë¡œ ì„¤ì •

  drawWheel();
  createSettingsForm();
  spinButton.onclick = spinWheel;

  // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ LocalStorageì— ì €ì¥
document.getElementById('saveSettings').onclick = () => {
  localStorage.setItem('rouletteOptions', JSON.stringify(options));
  alert('í•­ëª© ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

document.getElementById('resetToDefault').onclick = () => {
  options = Array.from({ length: 30 }, (_, i) => ({
    name: `${i + 1}`,
    probability: 999,
    color: `hsl(${(i * 12) % 360}, 80%, 60%)`
  }));
  drawWheel();
  createSettingsForm();
  alert('ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

// ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì €ì¥ëœ ì„¤ì • ë³µì›
document.getElementById('loadSettings').onclick = () => {
  const saved = localStorage.getItem('rouletteOptions');
  if (!saved) {
    alert('ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  try {
    const parsed = JSON.parse(saved);
    if (Array.isArray(parsed)) {
      options = parsed;
      createSettingsForm();
      drawWheel();
      alert('ì„¤ì •ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');
    } else {
      throw new Error();
    }
  } catch (e) {
    alert('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};
const slotsDiv = document.getElementById('slots');

function createSlotControls() {
  slotsDiv.innerHTML = '';
  for (let i = 1; i <= 6; i++) {
    const row = document.createElement('div');
    row.style.marginBottom = '10px';

    const label = document.createElement('span');
    label.textContent = `ìŠ¬ë¡¯ ${i}ë²ˆ`;

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ì €ì¥';
    saveBtn.onclick = () => {
      localStorage.setItem(`rouletteSlot${i}`, JSON.stringify(options));
      alert(`ìŠ¬ë¡¯ ${i}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    };

    const loadBtn = document.createElement('button');
    loadBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
    loadBtn.onclick = () => {
      const data = localStorage.getItem(`rouletteSlot${i}`);
      if (data) {
        try {
          const parsed = JSON.parse(data);
          if (Array.isArray(parsed)) {
            options = parsed;
            createSettingsForm();
            drawWheel();
            alert(`ìŠ¬ë¡¯ ${i} ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
          } else {
            throw new Error();
          }
        } catch {
          alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: í˜•ì‹ ì˜¤ë¥˜');
        }
      } else {
        alert('í•´ë‹¹ ìŠ¬ë¡¯ì— ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    };

    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'ì´ˆê¸°í™”';
    clearBtn.onclick = () => {
      const defaultOptions = Array.from({ length: 30 }, (_, i) => ({
        name: `${i + 1}`,
        probability: 999,
        color: `hsl(${(i * 12) % 360}, 80%, 60%)`
      }));
      localStorage.setItem(`rouletteSlot${i}`, JSON.stringify(defaultOptions));

      // ğŸ‘‰ ì‹¤ì œ í™”ë©´ë„ ì´ ì´ˆê¸°ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
      options = defaultOptions;
      createSettingsForm();
      drawWheel();

      alert(`ìŠ¬ë¡¯ ${i}ê°€ ì´ˆê¸° ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };
    row.append(label, saveBtn, loadBtn, clearBtn);
    slotsDiv.appendChild(row);
  }
}

createSlotControls(); // ìµœì´ˆ ì‹¤í–‰ ì‹œ ìƒì„±

</script>
</body>
</html>
