<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>Sleep</title>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --text-color: #000;
      --btn-bg: #000;
      --btn-hover: #45a049;
      --modal-bg: rgba(0, 0, 0, 0.5);
    }

    body.dark {      
      --bg-color: #202020;
      --text-color: #eee;
      --btn-bg: #44a148;
      --btn-hover: #66BB6A
    }

    body {
      margin: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: "Nanum Gothic", sans-serif;
      font-weight: 700;
    }

    .container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }

    #wheel-section {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #wheel {
      width: 600px;
      height: 600px;
      border-radius: 50%;
      border: 10px solid #333;
      overflow: hidden;
      transform: rotate(0deg);
      transition: transform 5s ease-out;
    }

    #arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -300px);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 30px solid red;
      z-index: 10;
    }

    #wheelCanvas {
      width: 100%;
      height: 100%;
    }

    #control-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    button {
      padding: 8px 12px;
      margin: 5px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background-color: var(--btn-bg);
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--btn-hover);
    }

    #result {
      font-size: 20px;
      margin: 10px 0;
    }

    .option-setting {
      display: flex;
      gap: 5px;
      margin-bottom: 8px;
      align-items: center;
    }

    .option-setting input[type="text"] {
      flex: 1;
    }

    .option-setting input[type="number"] {
      width: 60px;
    }

    .option-setting input[type="color"] {
      width: 40px;
      border: none;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--modal-bg);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
      border-radius: 10px;
      max-height: 90vh;
      overflow-y: auto;
      width: 600px;
    }

    .modal-content h2 {
      margin-top: 0;
    }

    #slots div {
      display: flex;
      gap: 5px;
      margin-bottom: 6px;
    }

    #darkToggle {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <div id="wheel-section">
    <div id="arrow"></div>
    <div id="wheel"><canvas id="wheelCanvas" width="600" height="600"></canvas></div>
  </div>
  <div id="control-panel">
    <button id="spinButton">돌리기</button>
    <button id="openSettings">항목 보기</button>
    <button id="saveSettings">현재 룰렛 저장</button>
    <button id="loadSettings">최근 저장 불러오기</button>
    <button id="resetToDefault">룰렛 초기화</button>
    <label id="darkToggle"><input type="checkbox" id="darkModeToggle"> 다크모드</label>
    <div id="result"></div>
    <h3>슬롯 저장/불러오기</h3>
    <div id="slots"></div>
  </div>
</div>

<!-- 모달 -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>항목 설정</h2>
    <div id="settings"></div>
    <button onclick="document.getElementById('settingsModal').style.display='none'">닫기</button>
    <button id="addOption">항목 추가</button>
  </div>
</div>

<script>
  const canvas = document.getElementById('wheelCanvas');
  const ctx = canvas.getContext('2d');
  let rotation = 0;
  let spinning = false;

  let options = Array.from({ length: 30 }, (_, i) => ({
    name: `${i + 1}`,
    probability: 999,
    color: `hsl(${(i * 12) % 360}, 80%, 60%)`
  }));

  const resultDiv = document.getElementById('result');
  const wheelEl = document.getElementById('wheel');

  function drawWheel(highlightIndex = -1, blink = false) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const total = options.reduce((sum, o) => sum + o.probability, 0);
    let startAngle = -Math.PI / 2;

    options.forEach((opt, i) => {
      const sliceAngle = (opt.probability / total) * 2 * Math.PI;
      ctx.beginPath();
      ctx.moveTo(300, 300);
      ctx.arc(300, 300, 300, startAngle, startAngle + sliceAngle);
      ctx.closePath();
      ctx.fillStyle = opt.color;
      ctx.fill();

      if (i === highlightIndex && blink) {
        ctx.strokeStyle = '#FFD700';
        ctx.lineWidth = 5;
        ctx.stroke();
      }

      ctx.save();
      ctx.translate(300, 300);
      ctx.rotate(startAngle + sliceAngle / 2);
      ctx.fillStyle = "#fff";
      ctx.font = '16px Arial';
      ctx.textAlign = 'right';
      ctx.fillText(opt.name, 280, 10);
      ctx.restore();

      startAngle += sliceAngle;
    });
  }

  function pickByProbability() {
    const total = options.reduce((sum, opt) => sum + opt.probability, 0);
    let r = Math.random() * total, acc = 0;
    for (const opt of options) {
      acc += opt.probability;
      if (r <= acc) return opt;
    }
    return options[options.length - 1];
  }

  function spinWheel() {
    if (spinning) return;
    spinning = true;
    const total = options.reduce((sum, o) => sum + o.probability, 0);
    const target = pickByProbability();

    let angle = -90;
    for (let i = 0; i < options.length; i++) {
      const a = (options[i].probability / total) * 360;
      if (options[i] === target) break;
      angle += a;
    }
    const slice = (target.probability / total) * 360;
    const offset = (Math.random() - 0.5) * slice * 0.5;
    const targetAngle = angle + slice / 2 + offset;
    const fullSpins = 5 * 360;
    const newRotation = fullSpins + (360 - targetAngle);
    rotation += newRotation;
    wheelEl.style.transform = `rotate(${rotation}deg)`;

    setTimeout(() => {
      const finalAngle = (360 - (rotation % 360)) % 360;
      let acc = 0;
      let resultIndex = -1;
      for (let i = 0; i < options.length; i++) {
        const slice = (options[i].probability / total) * 360;
        if (finalAngle >= acc && finalAngle < acc + slice) {
          resultIndex = i;
          break;
        }
        acc += slice;
      }
      resultDiv.textContent = `결과: ${options[resultIndex].name}`;
      let blink = false, count = 0;
      const interval = setInterval(() => {
        blink = !blink;
        drawWheel(resultIndex, blink);
        if (++count >= 6) {
          clearInterval(interval);
          drawWheel();
        }
      }, 500);
      spinning = false;
    }, 5000);
  }

  function createSettingsForm() {
    const settingsDiv = document.getElementById('settings');
    settingsDiv.innerHTML = '';
    options.forEach((opt, i) => {
      const row = document.createElement('div');
      row.className = 'option-setting';

      const name = document.createElement('input');
      name.type = 'text';
      name.value = opt.name;
      name.oninput = e => { opt.name = e.target.value; drawWheel(); };

      const prob = document.createElement('input');
      prob.type = 'number';
      prob.value = opt.probability;
      prob.oninput = e => { opt.probability = parseInt(e.target.value) || 0; drawWheel(); };

      const color = document.createElement('input');
      color.type = 'color';
      color.value = opt.color;
      color.oninput = e => { opt.color = e.target.value; drawWheel(); };

      const del = document.createElement('button');
      del.textContent = '삭제';
      del.onclick = () => {
        options.splice(i, 1);
        createSettingsForm(); drawWheel();
      };

      row.append(name, prob, color, del);
      settingsDiv.appendChild(row);
    });
  }

  document.getElementById('spinButton').onclick = spinWheel;
  document.getElementById('openSettings').onclick = () => {
    document.getElementById('settingsModal').style.display = 'flex';
    createSettingsForm();
  };
  document.getElementById('addOption').onclick = () => {
    options.push({ name: `${options.length + 1}`, probability: 999, color: '#cccccc' });
    createSettingsForm(); drawWheel();
  };
  document.getElementById('saveSettings').onclick = () => {
    localStorage.setItem('rouletteOptions', JSON.stringify(options));
    alert('저장됨!');
  };
  document.getElementById('loadSettings').onclick = () => {
    const saved = localStorage.getItem('rouletteOptions');
    if (!saved) return alert('없어요');
    try {
      options = JSON.parse(saved);
      createSettingsForm(); drawWheel();
    } catch {
      alert('불러오기 실패');
    }
  };
  document.getElementById('resetToDefault').onclick = () => {
    options = Array.from({ length: 30 }, (_, i) => ({
      name: `${i + 1}`, probability: 999, color: `hsl(${(i * 12) % 360}, 80%, 60%)`
    }));
    createSettingsForm(); drawWheel();
  };
  document.getElementById('darkModeToggle').onchange = e => {
    document.body.classList.toggle('dark', e.target.checked);
  };

  function createSlotControls() {
    const slotsDiv = document.getElementById('slots');
    slotsDiv.innerHTML = '';
    for (let i = 1; i <= 6; i++) {
      const row = document.createElement('div');
      row.innerHTML = `슬롯 ${i}번`;
      ['저장', '불러오기', '초기화'].forEach(action => {
        const btn = document.createElement('button');
        btn.textContent = action;
        btn.onclick = () => {
          const key = `slot${i}`;
          if (action === '저장') {
            localStorage.setItem(key, JSON.stringify(options));
            alert(`${key} 저장됨`);
          } else if (action === '불러오기') {
            const data = localStorage.getItem(key);
            if (data) {
              options = JSON.parse(data);
              drawWheel(); createSettingsForm();
              alert(`${key} 불러옴`);
            } else {
              alert('없음');
            }
          } else if (action === '초기화') {
            options = Array.from({ length: 30 }, (_, i) => ({
              name: `${i + 1}`, probability: 999, color: `hsl(${(i * 12) % 360}, 80%, 60%)`
            }));
            localStorage.setItem(key, JSON.stringify(options));
            drawWheel(); createSettingsForm();
            alert(`${key} 초기화`);
          }
        };
        row.appendChild(btn);
      });
      slotsDiv.appendChild(row);
    }
  }

  createSlotControls();
  drawWheel();
</script>
</body>
</html>
